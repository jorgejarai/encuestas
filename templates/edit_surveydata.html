<!--herencia de base.html -->
{% extends 'base.html' %} {% block content %}
<form
  action="/update/{{encuesta._id}}"
  method="POST"
  onSubmit="handleSubmit(event)"
>
  <input type="hidden" name="payload" value="" />
  <input type="hidden" name="questions" value="{{ num_q }}" />
  <label for="surveyName">Nombre encuesta:</label><br />
  <input
    type="text"
    id="surveyName"
    name="surveyName"
    size="60"
    placeholder="Inserte nombre"
    value="{{encuesta.title}}"
  /><br />
  <label for="interests">Intereses:</label><br />
  <input
    type="text"
    id="interests"
    name="interests"
    size="60"
    placeholder="Inserte intereses"
    value="{{encuesta.interests[0]}}"
  /><br />
  <br />
  {% for i in range(0,num_q) %}
  <input type="hidden" name="num_alt{{ i }}" value="{{ num_a[i] }}" />
  <label for="p{{ i }}">Pregunta {{i+1}}</label><br />
  <input
    type="text"
    name="p{{ i }}"
    size="60"
    placeholder="Inserte pregunta"
    value="{{encuesta.questions[i].label}}"
  /><br /><br />
  {% for j in range(0,num_a[i]) %} Alternativa:
  <input
    type="text"
    name="a{{ i }}-{{ j }}"
    size="30"
    placeholder="Inserte alternativa"
    value="{{encuesta.questions[i].alternatives[j].label}}"
  /><br /><br />
  {% endfor %} {% endfor %}

  <input type="submit" name="Guardar" value="Guardar" />
</form>

<script>
  var getQuestions = () => {
    const numQuestions = parseInt($('[name="questions"]').val(), 10);
    const numAlternatives = {};

    for (let i = 0; i < numQuestions; i++) {
      numAlternatives[i] = parseInt($('[name="num_alt' + i + '"]').val(), 10);
    }

    const ret = [];

    Object.keys(numAlternatives).forEach((i) => {
      const question = {};

      question.title = $('[name="p' + i + '"]').val();
      question.alternatives = [];

      for (let j = 0; j < numAlternatives[i]; j++) {
        question.alternatives = [
          ...question.alternatives,
          $('[name="a' + i + '-' + j + '"]').val(),
        ];
      }

      ret.push(question);
    });

    return ret;
  };

  var handleSubmit = (e) => {
    $('[name="payload"]').val(JSON.stringify({ questions: getQuestions() }));
  };
</script>

{% endblock %}
